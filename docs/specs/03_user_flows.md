# 03. User Flows — Mini App

> Клиентский путь от входа до получения заказа

---

## 1. Общий User Flow

```
Шаг 0: Переход из рекламы / рассылки / канала → TG бот
        │
Шаг 1: Открывает Mini App из бота (кнопка "Открыть меню")
        │
Шаг 2: Система запрашивает геолокацию
        │
        ├─ Разрешил → Шаг 3
        └─ Отказал → Ручной выбор точки
        │
Шаг 3: Показать ближайшие точки на карте
        │
Шаг 4: Выбор точки → загрузка меню
        │
Шаг 5: Добавление товаров в корзину
        │
Шаг 6: Ввод промокода (опционально)
        │
Шаг 7: Оплата через Telegram Payments
        │
Шаг 8: Заказ создан → уведомления
        │
Шаг 9-12: Статусы заказа (принят → готовится → готов → выдан)
```

---

## 2. Экраны Mini App

### 2.1 Онбординг и выбор точки

```
┌───────────────────────────────────────────────────────────────────────────┐
│                           ЭКРАН: ЗАПРОС ГЕОЛОКАЦИИ                        │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                              📍                                            │
│                                                                           │
│                    Разрешите доступ к геолокации                          │
│                                                                           │
│                 Чтобы показать ближайшие кофейни                          │
│                                                                           │
│                                                                           │
│                    ┌─────────────────────────┐                            │
│                    │       Разрешить         │                            │
│                    └─────────────────────────┘                            │
│                                                                           │
│                    ┌─────────────────────────┐                            │
│                    │    Выбрать вручную      │                            │
│                    └─────────────────────────┘                            │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘

                              │
            ┌─────────────────┴─────────────────┐
            │                                   │
            ▼                                   ▼

┌───────────────────────────┐     ┌───────────────────────────┐
│   КАРТА С ТОЧКАМИ         │     │   РУЧНОЙ ВЫБОР            │
│                           │     │                           │
│    [  Карта  ]            │     │   Город: [Москва ▼]       │
│                           │     │                           │
│    📍 Тверская 0.5км      │     │   • Тверская              │
│    📍 Арбат 1.2км         │     │     Тверская ул., 15      │
│    📍 Сити 2.1км          │     │                           │
│                           │     │   • Арбат                 │
│    [Списком]              │     │     Арбат, 24             │
│                           │     │                           │
└───────────────────────────┘     └───────────────────────────┘
```

### 2.2 Детали точки

```
┌───────────────────────────────────────────────────────────────────────────┐
│  ← Назад                                                                  │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌─────────────────────────────┐                        │
│                    │                             │                        │
│                    │       [Фото точки]          │                        │
│                    │                             │                        │
│                    └─────────────────────────────┘                        │
│                                                                           │
│  ☕ Кофейня Тверская                                                      │
│                                                                           │
│  📍 Тверская ул., 15, Москва                                             │
│                                                                           │
│  🕐 Сегодня: 08:00 — 22:00                                               │
│                                                                           │
│  ✅ Открыто                                                               │
│                                                                           │
│  📞 +7 999 123-45-67                                                      │
│                                                                           │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌─────────────────────────────┐                        │
│                    │    Выбрать эту точку        │                        │
│                    └─────────────────────────────┘                        │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Каталог (главный экран)

```
┌───────────────────────────────────────────────────────────────────────────┐
│  📍 Тверская ул., 15                                        [Сменить]    │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                         │
│  │  Кофе   │ │ Выпечка │ │   Еда   │ │ Напитки │      ← Табы категорий   │
│  │  ═══   │ │         │ │         │ │         │                         │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘                         │
│                                                                           │
│  ─────────────────────────────────────────────────────────────────────   │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  ┌───────────┐                                                      │ │
│  │  │           │  Капучино                                  NEW       │ │
│  │  │   ☕      │  Классический итальянский капучино                   │ │
│  │  │           │                                                      │ │
│  │  └───────────┘  от 320 ₽                              [+]           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  ┌───────────┐                                                      │ │
│  │  │           │  Латте                                               │ │
│  │  │   ☕      │  Мягкий кофейный напиток                             │ │
│  │  │           │                                                      │ │
│  │  └───────────┘  от 350 ₽                              [+]           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  ┌───────────┐                                        ┌──────────┐  │ │
│  │  │           │  Круассан                              │Раскупили │  │ │
│  │  │   🥐      │  Французский круассан                  └──────────┘  │ │
│  │  │           │                                                      │ │
│  │  └───────────┘  180 ₽                                 [—]           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌─────────────────────────────────┐                    │
│                    │  🛒 Корзина (2)          520 ₽  │                    │
│                    └─────────────────────────────────┘                    │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2.4 Карточка товара с модификаторами

```
┌───────────────────────────────────────────────────────────────────────────┐
│                                                                    [✕]   │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │                         [  Фото товара  ]                           │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  Капучино                                                          NEW   │
│  Классический итальянский капучино с нежной молочной пенкой              │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  РАЗМЕР *                                       (* — обязательный выбор) │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                       │
│  │  S (250мл)  │  │  M (350мл)  │  │  L (450мл)  │                       │
│  │    320 ₽    │  │    370 ₽    │  │    420 ₽    │                       │
│  │             │  │      ✓      │  │             │                       │
│  └─────────────┘  └─────────────┘  └─────────────┘                       │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  МОЛОКО                                                                   │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐                 │
│  │ Обычное   │ │ Овсяное   │ │ Кокосовое │ │Без молока │                 │
│  │    ✓      │ │  +60 ₽    │ │  +60 ₽    │ │           │                 │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘                 │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  СИРОП (до 3 шт)                                                          │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐                 │
│  │  Ваниль   │ │ Карамель  │ │Лес. орех  │ │  Кокос    │                 │
│  │  +40 ₽    │ │  +40 ₽    │ │  +40 ₽    │ │  +40 ₽    │                 │
│  │    ☑      │ │           │ │           │ │           │                 │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘                 │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  Комментарий к заказу:                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ Без сахара                                                          │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│       [−]  1  [+]              ┌─────────────────────────────┐           │
│                                │  Добавить в корзину  410 ₽  │           │
│                                └─────────────────────────────┘           │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2.5 Корзина

```
┌───────────────────────────────────────────────────────────────────────────┐
│  ← Корзина                                                                │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  📍 Тверская ул., 15                                        [Изменить]   │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  ┌───────────┐                                                      │ │
│  │  │    ☕     │  Капучино M                                          │ │
│  │  │           │  Овсяное молоко, Ваниль                              │ │
│  │  └───────────┘  💬 Без сахара                                       │ │
│  │                                                                      │ │
│  │                 [−]  1  [+]                              430 ₽  [🗑] │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  ┌───────────┐                                                      │ │
│  │  │    🥐     │  Круассан                                            │ │
│  │  │           │                                                      │ │
│  │  └───────────┘                                                      │ │
│  │                                                                      │ │
│  │                 [−]  2  [+]                              360 ₽  [🗑] │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  Промокод:                                                                │
│  ┌────────────────────────────────────┐  ┌───────────┐                   │
│  │ COFFEE10                           │  │ Применить │                   │
│  └────────────────────────────────────┘  └───────────┘                   │
│                                                                           │
│  ✅ Скидка 10% применена: -79 ₽                                          │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  Сумма заказа                                                      790 ₽ │
│  Скидка                                                            -79 ₽ │
│  ─────────────────────────────────────────────────────────────────────── │
│  Итого                                                             711 ₽ │
│                                                                           │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌─────────────────────────────────┐                    │
│                    │     💳 Оплатить 711 ₽          │                    │
│                    └─────────────────────────────────┘                    │
│                                                                           │
│  Нажимая "Оплатить", вы соглашаетесь с условиями оферты                  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2.6 Статус заказа

```
┌───────────────────────────────────────────────────────────────────────────┐
│  ← Заказ #42                                                              │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                              ☕                                            │
│                                                                           │
│                         Готовится                                         │
│                   Примерно 3-5 минут                                      │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  ●────────────────●────────────────●────────────────○                     │
│  Оплачен        Принят        Готовится          Готов                    │
│  14:32          14:33          14:34                                      │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  📍 Тверская ул., 15                                                      │
│                                                                           │
│  ═══════════════════════════════════════════════════════════════════════ │
│                                                                           │
│  Капучино M                                                               │
│  Овсяное молоко, Ваниль                                            430 ₽ │
│                                                                           │
│  Круассан × 2                                                      360 ₽ │
│                                                                           │
│  ─────────────────────────────────────────────────────────────────────── │
│  Скидка COFFEE10                                                   -79 ₽ │
│  ─────────────────────────────────────────────────────────────────────── │
│  Итого                                                             711 ₽ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2.7 История заказов

```
┌───────────────────────────────────────────────────────────────────────────┐
│  ← Мои заказы                                                             │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  Сегодня                                                                  │
│  ─────────────────────────────────────────────────────────────────────── │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  #42                                               🟡 Готовится     │ │
│  │  Тверская ул., 15                                                   │ │
│  │  Капучино M, Круассан × 2                                   711 ₽   │ │
│  │  14:32                                                              │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  Вчера                                                                    │
│  ─────────────────────────────────────────────────────────────────────── │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  #38                                               ✅ Выдан         │ │
│  │  Арбат, 24                                                          │ │
│  │  Латте L                                                    420 ₽   │ │
│  │  Вчера, 09:15                                                       │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  #35                                               ✅ Выдан         │ │
│  │  Тверская ул., 15                                                   │ │
│  │  Американо M, Круассан                                      460 ₽   │ │
│  │  Вчера, 08:45                                                       │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Статусы заказа и Push-уведомления

### 3.1 Диаграмма статусов

```
    ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
    │ ОПЛАЧЕН │ ───▶ │ ПРИНЯТ  │ ───▶ │ГОТОВИТСЯ│ ───▶ │  ГОТОВ  │
    │  paid   │      │ accepted│      │preparing│      │  ready  │
    └────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘
         │                │                │                │
         ▼                ▼                ▼                ▼
    ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
    │  Push:  │      │  Push:  │      │  Push:  │      │  Push:  │
    │"Оплачен"│      │"Принят" │      │"Готовит-│      │ "Готов! │
    │         │      │         │      │  ся"    │      │Заберите"│
    └─────────┘      └─────────┘      └─────────┘      └────┬────┘
                                                            │
                                                            ▼
                                                       ┌─────────┐
                                                       │  ВЫДАН  │
                                                       │completed│
                                                       └────┬────┘
                                                            │
                                                            ▼
                                                       ┌─────────┐
                                                       │  Push:  │
                                                       │"Спасибо"│
                                                       └─────────┘
```

### 3.2 Тексты Push-уведомлений

| Статус | Текст уведомления |
|--------|-------------------|
| `paid` | ✅ Заказ #42 оплачен!<br>📍 Кофейня Тверская<br>💰 711 ₽ |
| `accepted` | 👨‍🍳 Ваш заказ #42 принят!<br>Скоро начнём готовить |
| `preparing` | ☕ Ваш заказ #42 готовится!<br>Примерно 3-5 минут |
| `ready` | 🎉 Заказ #42 готов!<br>Заберите на кассе<br>📍 Тверская ул., 15 |
| `completed` | 🙏 Спасибо за заказ!<br>Ждём вас снова в Кофейня Тверская |
| `cancelled` | ❌ Заказ #42 отменён<br>Средства вернутся на карту |

---

## 4. Логика выбора точки

### 4.1 Алгоритм

```typescript
async function selectLocation(): Promise<Location> {
  // 1. Попробовать получить геолокацию
  const geoResult = await requestGeolocation();
  
  if (geoResult.success) {
    // 2. Найти ближайшие точки
    const nearby = await api.getLocations({
      lat: geoResult.latitude,
      lon: geoResult.longitude,
      radius: 5 // км
    });
    
    if (nearby.length > 0) {
      // 3. Показать карту с точками
      return await showMapWithLocations(nearby);
    } else {
      // 4. Нет точек рядом — показать ближайшую
      const closest = await api.getLocations({ limit: 1 });
      const confirm = await showConfirmDialog(
        `Ближайшая точка в ${closest[0].distance_km} км. Показать?`
      );
      if (confirm) {
        return closest[0];
      }
    }
  }
  
  // 5. Fallback — ручной выбор
  return await showManualLocationPicker();
}
```

### 4.2 Проверка доступности точки

```typescript
function checkLocationAvailability(location: Location): AvailabilityResult {
  // Проверить статус
  if (location.status !== 'active') {
    return { available: false, reason: 'inactive' };
  }
  
  // Проверить флаг приёма заказов
  if (!location.is_accepting_orders) {
    return { available: false, reason: 'not_accepting' };
  }
  
  // Проверить рабочие часы
  const now = new Date();
  const dayName = getDayName(now);
  const hours = location.working_hours[dayName];
  
  if (!hours.is_working) {
    return { 
      available: false, 
      reason: 'day_off',
      next_open_at: getNextOpenTime(location)
    };
  }
  
  const currentTime = formatTime(now);
  if (currentTime < hours.open || currentTime > hours.close) {
    return {
      available: false,
      reason: 'outside_hours',
      working_hours: hours
    };
  }
  
  return { available: true };
}
```

---

## 5. Логика корзины

### 5.1 Структура элемента корзины

```typescript
interface CartItem {
  id: string;                    // Уникальный ID в корзине
  product_id: string;
  product_name: string;
  product_image_url: string;
  quantity: number;
  
  // Цены
  base_price: number;            // Базовая цена товара
  modifiers_price: number;       // Сумма доплат за модификаторы
  unit_price: number;            // base_price + modifiers_price
  total_price: number;           // unit_price × quantity
  
  // Выбранные модификаторы
  modifiers: {
    group_id: string;
    group_name: string;
    option_id: string;
    option_name: string;
    price_adjustment: number;
  }[];
  
  // Комментарий
  comment?: string;
}
```

### 5.2 Расчёт цены

```typescript
function calculateItemPrice(
  product: Product,
  selectedModifiers: ModifierOption[]
): number {
  const basePrice = product.price;
  const modifiersPrice = selectedModifiers.reduce(
    (sum, mod) => sum + mod.price_adjustment, 
    0
  );
  return basePrice + modifiersPrice;
}

function calculateCartTotal(
  items: CartItem[],
  promoCode?: PromoCode
): CartTotals {
  const subtotal = items.reduce((sum, item) => sum + item.total_price, 0);
  
  let discount = 0;
  if (promoCode) {
    if (promoCode.type === 'percentage') {
      discount = Math.min(
        subtotal * (promoCode.discount_value / 100),
        promoCode.max_discount_amount || Infinity
      );
    } else {
      discount = promoCode.discount_value;
    }
  }
  
  return {
    subtotal,
    discount,
    total: subtotal - discount
  };
}
```

---

## 6. Валидация корзины

```typescript
async function validateCart(
  cart: CartItem[], 
  locationId: string
): Promise<ValidationResult> {
  const errors: ValidationError[] = [];
  const warnings: ValidationWarning[] = [];
  
  // 1. Проверить точку
  const location = await api.getLocation(locationId);
  const availability = checkLocationAvailability(location);
  
  if (!availability.available) {
    errors.push({
      type: 'location_unavailable',
      message: getUnavailabilityMessage(availability)
    });
    return { valid: false, errors, warnings };
  }
  
  // 2. Проверить каждый товар
  const menu = await api.getLocationMenu(locationId);
  
  for (const item of cart) {
    const product = menu.findProduct(item.product_id);
    
    if (!product) {
      errors.push({
        type: 'product_not_found',
        itemId: item.id,
        message: `"${item.product_name}" больше недоступен`
      });
      continue;
    }
    
    if (!product.is_available) {
      errors.push({
        type: 'product_unavailable',
        itemId: item.id,
        message: `"${product.name}" — ${product.unavailable_reason || 'временно недоступен'}`
      });
      continue;
    }
    
    if (product.stock_quantity < item.quantity) {
      errors.push({
        type: 'insufficient_stock',
        itemId: item.id,
        message: `"${product.name}" — осталось только ${product.stock_quantity} шт`
      });
    }
    
    // Проверить изменение цены
    const currentPrice = calculateItemPrice(product, item.modifiers);
    if (currentPrice !== item.unit_price) {
      warnings.push({
        type: 'price_changed',
        itemId: item.id,
        oldPrice: item.unit_price,
        newPrice: currentPrice
      });
    }
  }
  
  return {
    valid: errors.length === 0,
    errors,
    warnings
  };
}
```

# PRD: Цифровая кофейня v1.0

> **Версия:** 1.0  
> **Дата:** Ноябрь 2024  
> **Статус:** Draft  

---

## Содержание и структура документации

Документация разделена на модульные файлы для удобства работы в Cursor / Claude Code.

### Файлы документации

| # | Файл | Описание |
|---|------|----------|
| 01 | [01_overview.md](./01_overview.md) | Обзор продукта, регистрация через бота, техстек |
| 02 | [02_database_schema.md](./02_database_schema.md) | Схема базы данных PostgreSQL (19 таблиц) |
| 03 | [03_user_flows.md](./03_user_flows.md) | User Flow клиента в Mini App |
| 04 | [04_api_endpoints.md](./04_api_endpoints.md) | API контракты (Public, Barista, Admin, Webhooks) |
| 05 | [05_admin_hub.md](./05_admin_hub.md) | Админка Hub — все разделы |
| 06 | [06_edge_cases.md](./06_edge_cases.md) | Edge Cases и обработка ошибок |
| 07 | [07_barista_tvboard.md](./07_barista_tvboard.md) | Табло баристы и TV-борд |
| 08 | [08_payments.md](./08_payments.md) | Модуль оплаты (Telegram Payments) |

---

## Краткий обзор системы

### Концепция

**Цифровая кофейня** — tech-first платформа для сети кофеен формата take-away, масштабируемая по франчайзинговой модели.

### Ключевые принципы

- **Без регистрации** — авторизация через Telegram
- **Мультиплатформенность** — Mini Apps в мессенджерах
- **Единая точка контроля** — Hub (админка) для управления сетью
- **Точка = Адрес** — каждая локация имеет свои настройки и поддомен

### Архитектура

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              КЛИЕНТСКИЙ СЛОЙ                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐         ┌─────────────────────────────────────────────┐   │
│  │   TG БОТ    │────────▶│            TELEGRAM MINI APP                │   │
│  │  @brand_bot │         │  • Выбор точки (гео)                        │   │
│  │             │         │  • Каталог с модификаторами                 │   │
│  │  • /start   │         │  • Корзина + промокод                       │   │
│  │  • Статусы  │         │  • Оплата (Telegram Payments)               │   │
│  └─────────────┘         └─────────────────────────────────────────────┘   │
└─────────────────────────────────────┬───────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API (NestJS)                                   │
│                             api.brand.ru/v1                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  /public/*     │  /barista/*   │  /admin/*      │  /webhooks/*             │
└─────────────────────────────────────┬───────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PostgreSQL (Supabase)                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
              ┌───────────────────────┼───────────────────────┐
              ▼                       ▼                       ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│   ТАБЛО БАРИСТЫ     │  │      TV-БОРД        │  │    HUB (АДМИНКА)    │
│   (TG Bot/Group)    │  │   *.board.brand.ru  │  │    hub.brand.ru     │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
```

### Технический стек

| Компонент | Технология |
|-----------|------------|
| Backend | NestJS (Node.js, TypeScript) |
| Database | PostgreSQL (Supabase) |
| Mini App | Flutter (Dart) → Web |
| Admin Hub | Solid.js |
| Payments | Telegram Payments API |
| Hosting Backend | Supabase |
| Hosting Frontend | Vercel |

---

## Scope v1.0

### В scope

- ✅ Регистрация через Telegram бота
- ✅ Mini App (каталог, корзина, оплата, статусы)
- ✅ Точка продаж (настройки, режим работы, поддомен)
- ✅ Меню с категориями и модификаторами
- ✅ Оплата через Telegram Payments
- ✅ 4 статуса заказа с push-уведомлениями
- ✅ Табло баристы (Telegram Bot)
- ✅ TV-борд (WebSocket realtime)
- ✅ Админка Hub (все разделы)
- ✅ Система ролей и доступов (RBAC)
- ✅ Промокоды (глобальные и локальные)
- ✅ Рассылки через бота

### Вне scope v1.0 (v2.0)

- ❌ Полноценный склад и поставки
- ❌ PWA версия
- ❌ Другие мессенджеры (WhatsApp, Viber)
- ❌ Программа лояльности
- ❌ Предзаказ на время
- ❌ Отзывы и рейтинги

---

## Роли и доступы

### Иерархия

```
УПРАВЛЯЮЩАЯ КОМПАНИЯ (УК)
├── Суперадмин — полный доступ
└── Сотрудники УК — по отделам (маркетинг, продажи, поддержка)

ФРАНЧАЙЗИ (ПАРТНЁР) — scope: свои точки
├── Партнёр — админ своих точек
├── Управляющий — урезанный доступ к Hub
└── Бариста — только табло заказов
```

### Матрица доступов

| Раздел | Суперадмин | Партнёр | Бариста |
|--------|:----------:|:-------:|:-------:|
| Категории | ✅ CRUD | 👁 View | ❌ |
| Товары | ✅ CRUD | 👁+остатки | ❌ |
| Заказы | ✅ Все | ✅ Свои | ✅ Статусы |
| Пользователи | ✅ Все | 👁 Свои | ❌ |
| Маркетинг | ✅ | ✅ Локально | ❌ |
| Сотрудники | ✅ Все | ✅ Свои | ❌ |
| Статистика | ✅ Все | ✅ Свои | ❌ |
| Точки | ✅ CRUD | ❌ | ❌ |

---

## Статусы заказа

```
ОПЛАЧЕН → ПРИНЯТ → ГОТОВИТСЯ → ГОТОВ → ВЫДАН
  paid    accepted  preparing   ready   completed
```

| Статус | Push клиенту | Кто меняет |
|--------|--------------|------------|
| paid | "Заказ оплачен!" | Система |
| accepted | "Ваш заказ принят!" | Бариста |
| preparing | "Готовится ☕" | Бариста |
| ready | "Готов! Заберите 🎉" | Бариста |
| completed | "Спасибо! 🙏" | Бариста |

---

## Ключевые сущности БД

| Таблица | Описание |
|---------|----------|
| `users` | Все пользователи (клиенты, баристы, партнёры, УК) |
| `locations` | Точки продаж |
| `categories` | Категории товаров |
| `products` | Глобальный каталог товаров |
| `modifier_groups` | Группы модификаторов (размер, молоко) |
| `modifier_options` | Опции модификаторов |
| `location_products` | Привязка товаров к точкам + остатки |
| `orders` | Заказы |
| `order_items` | Позиции заказов |
| `permissions` | Гранулярные права доступа |
| `promo_codes` | Промокоды |
| `broadcasts` | Рассылки |

---

## API Endpoints (обзор)

### Public (Mini App)
```
GET  /public/locations              # Список точек
GET  /public/locations/:id/menu     # Меню точки
POST /public/orders                 # Создать заказ
GET  /public/orders/:id             # Статус заказа
```

### Barista
```
GET   /barista/orders               # Заказы точки
PATCH /barista/orders/:id/status    # Изменить статус
PATCH /barista/stock/:id            # Обновить остаток
```

### Admin
```
CRUD /admin/locations/*
CRUD /admin/products/*
CRUD /admin/orders/*
CRUD /admin/promo-codes/*
CRUD /admin/staff/*
GET  /admin/dashboard
```

---

## Как использовать документацию

### Для разработчиков

1. Начните с `01_overview.md` для понимания контекста
2. Изучите `02_database_schema.md` перед созданием моделей
3. Используйте `04_api_endpoints.md` как контракт при разработке API
4. Сверяйтесь с `06_edge_cases.md` при обработке ошибок

### Для Cursor / Claude Code

Файлы структурированы для контекстного понимания:
- Каждый файл самодостаточен
- ASCII-диаграммы для визуализации
- Примеры кода на TypeScript
- Чёткие таблицы с данными

### Приоритет разработки

1. 🔴 **Critical**: БД, API (public), Mini App (каталог, корзина, оплата)
2. 🟡 **High**: Табло баристы, TV-борд, Статусы
3. 🟢 **Medium**: Hub (админка), Маркетинг, Доступы

---

## Ссылки

- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Telegram Mini Apps](https://core.telegram.org/bots/webapps)
- [Telegram Payments](https://core.telegram.org/bots/payments)
- [Supabase Docs](https://supabase.com/docs)
- [NestJS Docs](https://docs.nestjs.com)
- [Flutter Web](https://flutter.dev/web)
- [Solid.js Docs](https://www.solidjs.com/docs)

---

**Версия документа:** 1.0  
**Последнее обновление:** Ноябрь 2024
